import requests
import pandas as pd

def fetch_items(query, limit=50, max_results=150):
    url = f"https://api.mercadolibre.com/sites/MLA/search?q={query}&limit={limit}&offset="  
    all_items = []
    offset = 0

    while len(all_items) < max_results:
        response = requests.get(url + str(offset))

        if response.status_code == 200:
            data = response.json()
            all_items.extend(data['results'])  
            offset += limit  

            if len(data['results']) == 0:
                break
        else:
            print(f"Erro {response.status_code}: {response.text}")
            break

    return all_items

def fetch_item_details(item_id):
    url = f"https://api.mercadolibre.com/items/{item_id}"
    response = requests.get(url)

    if response.status_code == 200:
        return response.json()
    else:
        print(f"Error {response.status_code} item {item_id}")
        return None

queries = ['Google Home', 'Apple TV', 'Amazon Fire TV', 'Chromecast', 'Smart TV']

all_data = []

for query in queries:
    print(f"Product: {query}")
    items = fetch_items(query, max_results=150)

    for item in items:
        item_details = fetch_item_details(item['id'])
        if item_details:
            all_data.append({
                'titulo': item_details['title'],
                'precio': item_details['price'],
                'id': item_details['id'],
                'categoria': item_details['category_id'],
                'estado': item_details['condition'],
            })

df = pd.DataFrame(all_data)

df.to_csv("itens.csv", index=False)
